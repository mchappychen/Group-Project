---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---
```{r echo=FALSE, results="hide"}
library(splines)
library(modelr)
```

```{r}
data <- read_csv("SAT_School_Participation_and_Performance__2012-2013.csv")
```

```{r}
#Alex's contribution: Tidying up the data
df <- data %>% select(-1, -6, -9, -12) %>% rename(district = "District", school = "School", t_takes2012 = "Test-takers: 2012", t_takes2013 = "Test-takers: 2013", part_rate2012 = "Participation Rate (estimate): 2012", part_rate2013 = "Participation Rate (estimate): 2013", perc_mb2012 = "Percent Meeting Benchmark: 2012", perc_mb2013 = "Percent Meeting Benchmark: 2013")
df <- df %>% dplyr::filter(!(is.na(t_takes2012) | is.na(t_takes2013) | is.na(part_rate2012) | is.na(part_rate2013) | is.na(perc_mb2012) | is.na(perc_mb2013)))
df
```


bmr = number of meeting Benchmark / number of total seniors = (t_takes*perc_mb) / (t_takes/part_rate) = pec_mb*part_rate
bmr = perc_mb*part_rate*0.0001

We use bmr because it's a better measurement for comparing how well schools do. If 2 schools have the same percentage meeting benchmark, but one of them has a higher participation rate then the one with the higher participation rate is the better school.

```{r}
#Alex's contribution: creating BMR formula
#df1 is for testtakers for each school+year
df1 <- df %>% 
  select(1:4) %>% 
  rename(`2012` = t_takes2012, `2013` = t_takes2013) %>% 
  gather(3,4,key = "year", value = "t_takes") %>% 
  arrange(school)

#df2 is participation rate for each school+year
df2 <- df %>% select(1,2,5,6) %>% 
  rename(`2012` = part_rate2012, `2013` = part_rate2013) %>% 
  gather(3,4,key = "year", value = "part_rate")

#df3 is percentage meeting benchmark for each school+year
df3 <- df %>% 
  select(1,2,7,8) %>% 
  rename(`2012` = perc_mb2012, `2013` = perc_mb2013) %>% 
  gather(3,4,key = "year", value = "perc_mb")

#df4 combines them all
df4 <- df1 %>% 
  full_join(df2,by = c("district","school","year")) %>% 
  full_join(df3,by = c("district","school","year"))
df4 <- df4 %>% 
  mutate(bmr = perc_mb*part_rate*1e-4)

df4
```



First we'll get the senior population for each school (denoted as pop)
```{r}
data <- df4 %>% mutate(pop = floor(1e2*t_takes / part_rate))
```

Now lets plot it
```{r}
ggplot(data) + 
  geom_point(aes(pop,bmr),alpha=3/5) + 
  facet_wrap(~year) + 
  theme_bw()
```


The data is relatively scattered, but we can see a weak positive linear trend.

Let's use mean-square residuals
```{r}
#mean-square residuals
measure_distance <- function(mod,data){
  diff <- data$bmr - (mod[1] + data$pop*mod[2])
  sqrt(mean(diff^2))
}

best <- optim(c(0, 0), measure_distance, data = data)

ggplot(data, aes(pop, bmr)) + 
  geom_point(size = 2, colour = "grey30") + 
  geom_abline(color="blue",intercept = best$par[1], slope = best$par[2]) + 
  theme_bw()
```


```{r}
mod1 <- lm(bmr ~ ns(pop, 1), data = data)
mod2 <- lm(bmr ~ ns(pop, 2), data = data)
mod3 <- lm(bmr ~ log(pop, base = exp(1)), data = data)
mod4 <- lm(bmr ~ I(pop^2), data = data)

data %>% 
  gather_predictions(mod1, mod2, mod3, mod4) %>%
  ggplot(aes(pop, bmr)) + 
  geom_point(alpha=2/5) +
  geom_line(aes(pop,pred), colour = "red") +
  facet_grid(year~ model) + 
  theme_bw()
```

Let's check the residuals for any patterns
```{r}
data %>%
  gather_residuals(mod1,mod2,mod3,mod4) %>%
  ggplot(aes(resid)) + 
  geom_freqpoly(binwidth = 0.05) + 
  geom_vline(xintercept = 0, colour = "Green", size=0.5) + 
  facet_grid(year ~ model)
```

Looks approximately normal for all.

```{r}
data %>%
  gather_residuals(mod1,mod2,mod3,mod4) %>%
  ggplot(aes(pop, resid)) + 
  geom_hline(yintercept = 0, colour = "white", size = 2) + 
  geom_point(alpha=2/5) + 
  facet_grid(year ~ model)
```

Coefficient of Determination (r^2)

```{r}
summary(mod1)$r.squared
summary(mod2)$r.squared
summary(mod3)$r.squared
summary(mod4)$r.squared
```

These coefficients SUCK


What if I repeated something with districts that have more than 5 schools
```{r}
popularDistrict <- data %>%
  group_by(district) %>%
  summarize(n=n()) %>%
  dplyr::filter(n>10) %>%
  left_join(data,by="district") %>%
  select(-n)
popularDistrict
```

```{r}
ggplot(popularDistrict) +
  geom_point(aes(pop,bmr,color=district),alpha=3/5) + 
  facet_grid(district~year) + 
  theme_bw()
```




